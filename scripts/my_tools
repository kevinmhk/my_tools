#!/usr/bin/env bash

set -euo pipefail

tool_exists() {
  command -v "$1" >/dev/null 2>&1
}

get_term_cols() {
  local cols=""
  local rows=""

  if [ -n "${COLUMNS:-}" ] && [ "${COLUMNS:-0}" -gt 0 ] 2>/dev/null; then
    cols="$COLUMNS"
  elif command -v stty >/dev/null 2>&1; then
    if read -r rows cols < <(stty size </dev/tty 2>/dev/null); then
      :
    fi
  fi

  if [ -z "$cols" ] && command -v tput >/dev/null 2>&1; then
    cols=$(tput cols 2>/dev/null || true)
  fi

  if [ -z "$cols" ] || [ "${cols:-0}" -le 0 ] 2>/dev/null; then
    cols=80
  fi

  printf "%s" "$cols"
}

print_grid() {
  local category="$1"
  local col_width="$2"
  local category_width="$3"
  shift 3
  local -a tools=("$@")
  local -a sorted_tools
  local cols count available_cols

  if [ ${#tools[@]} -eq 0 ]; then
    return 0
  fi

  sorted_tools=()
  while IFS= read -r line; do
    [ -n "$line" ] && sorted_tools+=("$line")
  done < <(printf '%s\n' "${tools[@]}" | LC_ALL=C sort)

  cols=$(get_term_cols)
  if [ $col_width -le 0 ]; then
    col_width=1
  fi
  if [ $cols -le 0 ]; then
    cols=80
  fi
  local target_cols=4
  available_cols=$((cols - category_width))
  if [ $available_cols -lt $col_width ]; then
    available_cols=$col_width
  fi
  local num_cols=$((available_cols / col_width))
  if [ $num_cols -gt $target_cols ]; then
    num_cols=$target_cols
  elif [ $num_cols -lt $target_cols ] && [ $((target_cols * col_width)) -le $available_cols ]; then
    num_cols=$target_cols
  fi
  if [ $num_cols -lt 1 ]; then
    num_cols=1
  fi

  printf "%b%-${category_width}s%b" "$CATEGORY_COLOR" "$category" "$COLOR_RESET"
  count=0
  for tool in "${sorted_tools[@]}"; do
    printf "%b%-${col_width}s%b" "$TOOL_COLOR" "$tool" "$COLOR_RESET"
    count=$((count + 1))
    if [ $((count % num_cols)) -eq 0 ]; then
      printf "\n"
      if [ $count -lt ${#sorted_tools[@]} ]; then
        printf "%-${category_width}s" ""
      fi
    fi
  done
  if [ $((count % num_cols)) -ne 0 ]; then
    printf "\n"
  fi
  printf "\n"
}

entries=(
  "AI & Dev Agents:codex codexbar droid gemini opencode pi qwen"
  "Auth & Secrets:op"
  "Browser Automation:agent-browser playwright-cli"
  "Programming & Runtimes:bun firebase-tools flutter jq node python python3 ruff ty"
  "Cloud & Ops:tailscale"
  "Databases:harlequin lazysql sqlite3"
  "Docs & Preview:bat glow mmdc"
  "Editors:helix micro nvim vim"
  "Git & SCM:chezmoi delta difft gh git lazygit"
  "Package Managers:brew bun npm npx uv"
  "Search & Files:fd fzf rg yazi"
  "Shells:zsh"
  "Terminal Multiplexers:tmux zellij"
)

if [ -t 1 ] && [ -z "${NO_COLOR:-}" ]; then
  if [ -n "${CYAN:-}" ] && [ -n "${GREEN:-}" ] && [ -n "${RESET:-}" ]; then
    CATEGORY_COLOR="$CYAN"
    TOOL_COLOR="$GREEN"
    COLOR_RESET="$RESET"
  elif command -v tput >/dev/null 2>&1; then
    CATEGORY_COLOR=$'\033[38;5;51m'
    TOOL_COLOR=$(tput setaf 2)
    COLOR_RESET=$(tput sgr0)
  else
    CATEGORY_COLOR=""
    TOOL_COLOR=""
    COLOR_RESET=""
  fi
else
  CATEGORY_COLOR=""
  TOOL_COLOR=""
  COLOR_RESET=""
fi

sorted_entries=()
while IFS= read -r line; do
  [ -n "$line" ] && sorted_entries+=("$line")
done < <(printf '%s\n' "${entries[@]}" | LC_ALL=C sort)

categories=()
installed_lists=()
max_tool_len=0
max_category_len=0
for entry in "${sorted_entries[@]}"; do
  IFS=':' read -r category tools_line <<< "$entry"
  if [ -z "$category" ] || [ -z "$tools_line" ]; then
    continue
  fi

  installed=()
  for tool in $tools_line; do
    if tool_exists "$tool"; then
      installed+=("$tool")
      if [ ${#tool} -gt $max_tool_len ]; then
        max_tool_len=${#tool}
      fi
    fi
  done

  if [ ${#installed[@]} -gt 0 ]; then
    categories+=("$category")
    installed_lists+=("${installed[*]}")
    if [ ${#category} -gt $max_category_len ]; then
      max_category_len=${#category}
    fi
  fi
done

col_width=$((max_tool_len + 2))
if [ $col_width -le 0 ]; then
  col_width=1
fi
category_width=$((max_category_len + 2))
if [ $category_width -le 0 ]; then
  category_width=1
fi

for i in "${!categories[@]}"; do
  category="${categories[$i]}"
  tools_line="${installed_lists[$i]}"
  if [ -n "$tools_line" ]; then
    read -r -a installed_tools <<< "$tools_line"
    print_grid "$category" "$col_width" "$category_width" "${installed_tools[@]}"
  fi
done

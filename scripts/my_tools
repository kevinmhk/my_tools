#!/usr/bin/env bash

set -euo pipefail

script_dir=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
catalog_file=""

if [ -n "${MY_TOOLS_CATALOG:-}" ] && [ -f "${MY_TOOLS_CATALOG:-}" ]; then
  catalog_file="$MY_TOOLS_CATALOG"
elif [ -f "$script_dir/../data/tools.yaml" ]; then
  catalog_file="$script_dir/../data/tools.yaml"
elif [ -f "$HOME/.local/share/my_tools/tools.yaml" ]; then
  catalog_file="$HOME/.local/share/my_tools/tools.yaml"
fi

if [ -z "$catalog_file" ]; then
  echo "my_tools: tools catalog not found" >&2
  exit 1
fi

tool_exists() {
  command -v "$1" >/dev/null 2>&1
}

get_term_cols() {
  local cols=""
  local rows=""

  if [ -n "${COLUMNS:-}" ] && [ "${COLUMNS:-0}" -gt 0 ] 2>/dev/null; then
    cols="$COLUMNS"
  elif command -v stty >/dev/null 2>&1; then
    if tty -s 2>/dev/null; then
      if read -r rows cols < <(stty size 2>/dev/null); then
        :
      fi
    fi
  fi

  if [ -z "$cols" ] && command -v tput >/dev/null 2>&1; then
    cols=$(tput cols 2>/dev/null || true)
  fi

  if [ -z "$cols" ] || [ "${cols:-0}" -le 0 ] 2>/dev/null; then
    cols=80
  fi

  printf "%s" "$cols"
}

print_grid() {
  local category="$1"
  local col_width="$2"
  local category_width="$3"
  shift 3
  local -a tools=("$@")
  local -a sorted_tools
  local cols count available_cols

  if [ ${#tools[@]} -eq 0 ]; then
    return 0
  fi

  sorted_tools=()
  while IFS= read -r line; do
    [ -n "$line" ] && sorted_tools+=("$line")
  done < <(printf '%s\n' "${tools[@]}" | LC_ALL=C sort)

  cols=$(get_term_cols)
  if [ $col_width -le 0 ]; then
    col_width=1
  fi
  if [ $cols -le 0 ]; then
    cols=80
  fi
  local target_cols=4
  available_cols=$((cols - category_width))
  if [ $available_cols -lt $col_width ]; then
    available_cols=$col_width
  fi
  local num_cols=$((available_cols / col_width))
  if [ $num_cols -gt $target_cols ]; then
    num_cols=$target_cols
  elif [ $num_cols -lt $target_cols ] && [ $((target_cols * col_width)) -le $available_cols ]; then
    num_cols=$target_cols
  fi
  if [ $num_cols -lt 1 ]; then
    num_cols=1
  fi

  printf "%b%-${category_width}s%b" "$CATEGORY_COLOR" "$category" "$COLOR_RESET"
  count=0
  for tool in "${sorted_tools[@]}"; do
    printf "%b%-${col_width}s%b" "$TOOL_COLOR" "$tool" "$COLOR_RESET"
    count=$((count + 1))
    if [ $((count % num_cols)) -eq 0 ]; then
      printf "\n"
      if [ $count -lt ${#sorted_tools[@]} ]; then
        printf "%-${category_width}s" ""
      fi
    fi
  done
  if [ $((count % num_cols)) -ne 0 ]; then
    printf "\n"
  fi
  printf "\n"
}

entries=()

load_entries_from_yaml() {
  local file="$1"
  local current_category=""
  local -a current_tools=()
  local line trimmed tool

  while IFS= read -r line || [ -n "$line" ]; do
    line="${line%%#*}"
    trimmed="${line#"${line%%[![:space:]]*}"}"
    if [ -z "$trimmed" ]; then
      continue
    fi

    case "$trimmed" in
      "categories:")
        continue
        ;;
      "- name:"*)
        if [ -n "$current_category" ] && [ ${#current_tools[@]} -gt 0 ]; then
          entries+=("$current_category:${current_tools[*]}")
        fi
        current_category="${trimmed#- name:}"
        current_category="${current_category#" "}"
        current_category="${current_category%\"}"
        current_category="${current_category#\"}"
        current_tools=()
        ;;
      "tools:"*)
        continue
        ;;
      "- "*)
        tool="${trimmed#- }"
        tool="${tool%\"}"
        tool="${tool#\"}"
        if [ -n "$tool" ]; then
          current_tools+=("$tool")
        fi
        ;;
    esac
  done < "$file"

  if [ -n "$current_category" ] && [ ${#current_tools[@]} -gt 0 ]; then
    entries+=("$current_category:${current_tools[*]}")
  fi
}

load_entries_from_yaml "$catalog_file"

if [ ${#entries[@]} -eq 0 ]; then
  echo "my_tools: tools catalog is empty" >&2
  exit 1
fi

if [ -t 1 ] && [ -z "${NO_COLOR:-}" ]; then
  if [ -n "${CYAN:-}" ] && [ -n "${GREEN:-}" ] && [ -n "${RESET:-}" ]; then
    CATEGORY_COLOR="$CYAN"
    TOOL_COLOR="$GREEN"
    COLOR_RESET="$RESET"
  elif command -v tput >/dev/null 2>&1; then
    CATEGORY_COLOR=$'\033[38;5;51m'
    TOOL_COLOR=$(tput setaf 2)
    COLOR_RESET=$(tput sgr0)
  else
    CATEGORY_COLOR=""
    TOOL_COLOR=""
    COLOR_RESET=""
  fi
else
  CATEGORY_COLOR=""
  TOOL_COLOR=""
  COLOR_RESET=""
fi

sorted_entries=()
while IFS= read -r line; do
  [ -n "$line" ] && sorted_entries+=("$line")
done < <(printf '%s\n' "${entries[@]}" | LC_ALL=C sort)

categories=()
installed_lists=()
max_tool_len=0
max_category_len=0
for entry in "${sorted_entries[@]}"; do
  IFS=':' read -r category tools_line <<< "$entry"
  if [ -z "$category" ] || [ -z "$tools_line" ]; then
    continue
  fi

  installed=()
  for tool in $tools_line; do
    if tool_exists "$tool"; then
      installed+=("$tool")
      if [ ${#tool} -gt $max_tool_len ]; then
        max_tool_len=${#tool}
      fi
    fi
  done

  if [ ${#installed[@]} -gt 0 ]; then
    categories+=("$category")
    installed_lists+=("${installed[*]}")
    if [ ${#category} -gt $max_category_len ]; then
      max_category_len=${#category}
    fi
  fi
done

col_width=$((max_tool_len + 2))
if [ $col_width -le 0 ]; then
  col_width=1
fi
category_width=$((max_category_len + 2))
if [ $category_width -le 0 ]; then
  category_width=1
fi

for i in "${!categories[@]}"; do
  category="${categories[$i]}"
  tools_line="${installed_lists[$i]}"
  if [ -n "$tools_line" ]; then
    read -r -a installed_tools <<< "$tools_line"
    print_grid "$category" "$col_width" "$category_width" "${installed_tools[@]}"
  fi
done
